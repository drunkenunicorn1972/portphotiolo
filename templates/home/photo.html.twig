{% extends 'base.html.twig' %}

{% block title %}{{ photo.name }} - Photo Portfolio{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    {% if photo.latitude and photo.longitude %}
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
              integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
              crossorigin=""/>
        <style>
            #map {
                height: 400px;
                width: 100%;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
        </style>
    {% endif %}
{% endblock %}

{% block body %}
    <div class="container my-5">
        <div class="photo-detail">
            {# Breadcrumb #}
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ path('app_home') }}">Home</a></li>
                    {% if photo.albums|length > 0 %}
                        <li class="breadcrumb-item">
                            <a href="{{ path('app_album_view', {id: photo.albums.first.id}) }}">
                                {{ photo.albums.first.name }}
                            </a>
                        </li>
                    {% endif %}
                    <li class="breadcrumb-item active">{{ photo.name }}</li>
                </ol>
            </nav>

            {# Main Photo #}
            <div class="text-center mb-4">
                <picture>
                    <source media="(max-width: 768px)"
                            srcset="{{ asset('uploads/photos/' ~ (photo.filenameTablet ?? photo.filename)) }}">
                    <source media="(max-width: 1920px)"
                            srcset="{{ asset('uploads/photos/' ~ (photo.filenameDesktop ?? photo.filename)) }}">
                    <img src="{{ asset('uploads/photos/' ~ photo.filename) }}"
                         alt="{{ photo.name }}"
                         class="img-fluid">
                </picture>
            </div>

            {# Photo Information #}
            <div class="photo-meta">
                <div class="row">
                    <div class="col-md-8">
                        <h2>{{ photo.name }}</h2>

                        {% if photo.description %}
                            <p class="lead">{{ photo.description }}</p>
                        {% endif %}

                        {# Tags #}
                        {% if photo.tags|length > 0 %}
                            <div class="mb-3">
                                <strong><i class="fas fa-tags"></i> Tags:</strong><br>
                                {% for tag in photo.tags %}
                                    <span class="badge bg-success badge-tag">{{ tag.name }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}

                        {# Albums #}
                        {% if photo.albums|length > 0 %}
                            <div class="mb-3">
                                <strong><i class="fas fa-images"></i> Albums:</strong><br>
                                {% for album in photo.albums %}
                                    <a href="{{ path('app_album_view', {id: album.id}) }}"
                                       class="badge bg-primary badge-tag text-decoration-none">
                                        {{ album.name }}
                                    </a>
                                {% endfor %}
                            </div>
                        {% endif %}

                        {# Stats #}
                        <div class="d-flex gap-3">
                            <span class="badge bg-info">
                                <i class="fas fa-eye"></i> {{ photo.viewCount }} Views
                            </span>
                            <span class="badge bg-danger">
                                <i class="fas fa-heart"></i> {{ photo.likeCount }} Likes
                            </span>
                            {% if photo.rating %}
                                <span class="badge bg-warning">
                                    <i class="fas fa-star"></i> {{ photo.rating }}/5
                                </span>
                            {% endif %}
                        </div>
                    </div>

                    {# EXIF Data #}
                    <div class="col-md-4">
                        <h5><i class="fas fa-camera"></i> Photo Details</h5>
                        <table class="table table-sm">
                            {% if photo.device %}
                                <tr>
                                    <td><strong>Camera:</strong></td>
                                    <td>{{ photo.device }}</td>
                                </tr>
                            {% endif %}
                            {% if photo.createdAt %}
                                <tr>
                                    <td><strong>Date Taken:</strong></td>
                                    <td>{{ photo.createdAt|date('F j, Y') }}</td>
                                </tr>
                            {% endif %}
                            {% if photo.aperture %}
                                <tr>
                                    <td><strong>Aperture:</strong></td>
                                    <td>f/{{ photo.aperture }}</td>
                                </tr>
                            {% endif %}
                            {% if photo.focalLength %}
                                <tr>
                                    <td><strong>Focal Length:</strong></td>
                                    <td>{{ photo.focalLength }}mm</td>
                                </tr>
                            {% endif %}
                            {% if photo.exposureTime %}
                                <tr>
                                    <td><strong>Shutter Speed:</strong></td>
                                    <td>{{ photo.exposureTime }}</td>
                                </tr>
                            {% endif %}
                            {% if photo.iso %}
                                <tr>
                                    <td><strong>ISO:</strong></td>
                                    <td>{{ photo.iso }}</td>
                                </tr>
                            {% endif %}
                            <tr>
                                <td><strong>Flash:</strong></td>
                                <td>{{ photo.flash ? 'Yes' : 'No' }}</td>
                            </tr>
                            {% if photo.location %}
                                <tr>
                                    <td><strong>Location:</strong></td>
                                    <td>{{ photo.location }}</td>
                                </tr>
                            {% endif %}
                            {% if photo.copyright %}
                                <tr>
                                    <td><strong>Copyright:</strong></td>
                                    <td>{{ photo.copyright }}</td>
                                </tr>
                            {% endif %}
                        </table>
                    </div>
                </div>
            </div>

            {# Location Map #}
            {% if photo.latitude and photo.longitude %}
                <div class="mt-5">
                    <h5><i class="fas fa-map-marker-alt"></i> Photo Location</h5>
                    <div class="mb-2">
                        <small class="text-muted">
                            Coordinates: {{ photo.latitude }}, {{ photo.longitude }}
                            {% if photo.location %}
                                - {{ photo.location }}
                            {% endif %}
                        </small>
                    </div>
                    <div id="map"></div>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {% if photo.latitude and photo.longitude %}
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
                integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
                crossorigin=""></script>
        <script>
            // Initialize the map
            const map = L.map('map').setView([{{ photo.latitude }}, {{ photo.longitude }}], 13);

            // Add OpenStreetMap tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map);

            // Create custom marker icon (camera icon)
            const cameraIcon = L.divIcon({
                className: 'custom-camera-marker',
                html: '<i class="fas fa-camera fa-2x" style="color: #dc3545;"></i>',
                iconSize: [30, 30],
                iconAnchor: [15, 30],
                popupAnchor: [0, -30]
            });

            // Add marker with popup
            const marker = L.marker([{{ photo.latitude }}, {{ photo.longitude }}], {
                icon: cameraIcon
            }).addTo(map);

            // Create popup content
            const popupContent = `
                <div style="text-align: center;">
                    <img src="{{ asset('uploads/photos/' ~ (photo.filenameThumbnail ?? photo.filename)) }}"
                         alt="{{ photo.name }}"
                         style="max-width: 200px; max-height: 150px; border-radius: 4px; margin-bottom: 8px;">
                    <h6>{{ photo.name }}</h6>
                    {% if photo.location %}
                        <small>{{ photo.location }}</small>
                    {% endif %}
                    <br>
                    <small class="text-muted">{{ photo.latitude }}, {{ photo.longitude }}</small>
                </div>
            `;

            marker.bindPopup(popupContent);

            // Open popup by default
            marker.openPopup();
        </script>
    {% endif %}
{% endblock %}
